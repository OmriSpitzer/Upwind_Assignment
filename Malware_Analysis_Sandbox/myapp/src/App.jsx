import { useState, useEffect } from "react"
import axios from "axios"
import "./App.css"

// Server URL
const SERVER_URL = "http://localhost:8003"

// Time interval for retrieving logs
const TIME_INTERVAL = 2000

/**
 * Main App component
 * @returns App component
 */
function App() {
  // State variables
  const [isRunning, setIsRunning] = useState(false)             // Flag if the sandbox is running
  const [loading, setLoading] = useState(false)                 // Flag if the sandbox is loading
  const [logArray, setLogArray] = useState([])                  // Overall logs of the sandbox
  const [alert, setAlert] = useState(null)                      // Alert message

  // Functions
  /**
   * Initialize state variables
   */
  const initializeState = () => {
    setAlert(null)
    setLogArray([])
  }

  /**
  * Fetch the logs of the sandbox
  */
  const fetchLogs = async () => {
    setAlert(null)

    try {
      const response = await axios.get(`${SERVER_URL}/logs`)
      if (response.status === 200) {
        // Successfully received the response from the server
        const retreivedLogs = response.data.logs
        const updatedLogArray = Array.isArray(retreivedLogs) ? retreivedLogs : []

        // Update log array
        setLogArray(updatedLogArray)
      }
      else {
        setAlert(response.data.message)
      }
    } catch {
      setAlert("Failed to fetch logs")
    }
  }

  /**
   * Start listening to VM
   */
  const start = async () => {
    initializeState()
    setLoading(true)

    try {
      // send start request to server
      const response = await axios.post(`${SERVER_URL}/start`)
      if (response.status === 200) {
        // Successfully received the response from the server
        setIsRunning(true)
      }
      else {
        setAlert(response.data.message)
      }
    } catch {
      setAlert("Failed to start sandbox")
    } finally {
      setLoading(false)
    }
  }

  /**
   * Stop listening to VM
   */
  const stop = async () => {
    setLoading(true)

    try {
      // send stop request to server
      const response = await axios.post(`${SERVER_URL}/stop`)
      if (response.status === 200) {
        // Successfully received the response from the server
        setIsRunning(false)
      }
      else {
        setAlert(response.data.message)
      }
    } catch {
      setAlert("Failed to stop sandbox")
    } finally {
      setLoading(false)
      initializeState()
    }
  }

  /**
   * Run malware in the sandbox
   */
  const runMalware = async () => {

    try {
      const response = await axios.post(`${SERVER_URL}/runMalware`)

      // Check if the malware is running
      if (response.status !== 200) {
        setAlert(response.data.message)
      }
    } catch {
      setAlert("Failed to run malware")
    }
  }
  /**
   * Fetch new logs every TIME_INTERVAL milliseconds while running
   */
  useEffect(() => {
    if (!isRunning) return

    const run_function = () => fetchLogs()
    const intervalId = setInterval(run_function, TIME_INTERVAL)

    return () => clearInterval(intervalId)
  }, [isRunning])

  return (
    <div className="h-full w-full flex flex-col items-center justify-center">
      <div className="h-full w-300 flex flex-col items-center justify-between gap-10 bg-white rounded-md p-10">
        {/* Title */}
        <h1>Malware Analysis Sandbox</h1>

        {/* Buttons */}
        <div className="flex flex-row items-center justify-center gap-2">
          {/* Listening button */}
          <button
            className={isRunning ? "btn-stop" : "btn-start"}
            onClick={isRunning ? stop : start}
            disabled={loading}
          >
            {isRunning ? "Stop Listening" : "Start Listening"}
          </button>

          {/* Run Malware button */}
          {isRunning &&
            <button
              onClick={runMalware}
              className={"btn-run"}
            >
              Run Malware
            </button>}
        </div>
        {/* Alert message */}
        {alert && <p className='border-2 rounded-md p-2 text-red-500'>{alert}</p>}

        {/* Log terminal */}
        <div className='h-90 w-full flex flex-col bg-gray-200 rounded-md p-2 overflow-y-auto overflow-x-hidden border-3 border-gray-300'>
          {loading || logArray.length === 0 ? (
            /* Loading or no logs */
            <div className='flex flex-col items-center justify-center h-full'>
              <h2 className="text-center font-semibold text-2xl">
                {loading ?
                  "Loading..." :
                  isRunning ?
                    "Waiting for activity…" :
                    "Click “Start Listening” to begin monitoring"}
              </h2>
            </div>) : (
            /* Logs */
            logArray.map((log, index) => (
              <div className="w-full flex flex-col mt-2" key={index}>
                {/* Header */}
                <div className="flex flex-row items-center justify-between gap-2">
                  <h2 className="font-bold">{log.action}</h2>
                  <h2>{log.file}</h2>
                  <h2 className="font-semibold">{log.time}</h2>
                </div>

                {/* Network Snapshot */}
                {log.network && (
                  <details className="text-sm">
                    <summary className="cursor-pointer">Network (snapshot)</summary>
                    <pre
                      className="p-2 bg-gray-100 overflow-x-auto overflow-y-auto max-h-28 text-xs">
                      {log.network}
                    </pre>
                  </details>
                )}

                {/* Process Snapshot */}
                {log.process && (
                  <details className="text-sm">
                    <summary className="cursor-pointer">Process (snapshot)</summary>
                    <pre
                      className="p-2 bg-gray-100 overflow-x-auto overflow-y-auto max-h-28 text-xs ">
                      {log.process}
                    </pre>
                  </details>
                )}

                <hr className="w-full border-gray-300 border-4 mt-2" />
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  )
}

export default App
