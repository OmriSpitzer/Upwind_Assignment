from dotenv import load_dotenv
from flask import Flask, jsonify
from flask_cors import CORS
import subprocess
import os

load_dotenv()
VBOX_PATH = os.getenv("VBOX_PATH")
VM_NAME = os.getenv("VM_NAME")
VM_USERNAME = os.getenv("VM_USERNAME")
VM_PASSWORD = os.getenv("VM_PASSWORD")
GUEST_SCRIPT_PATH = os.getenv("GUEST_SCRIPT_PATH", "C:\\SandboxShare\\script1.bat")

app = Flask(__name__)
CORS(app)

IS_START = False

def vbox(args, capture_output=False):
    """Run VBoxManage. If capture_output=True, returns (returncode, stdout, stderr)."""
    if capture_output:
        result = subprocess.run(
            [VBOX_PATH] + args,
            capture_output=True,
            text=True,
            shell=False,
        )
        return result.returncode, result.stdout or "", result.stderr or ""
    subprocess.run(
        [VBOX_PATH] + args,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
        shell=False,
    )

@app.route("/start", methods=["POST"])
def start():
    global IS_START

    print("\n- - - Starting Analysis - - -\n")
    vbox(["startvm", VM_NAME, "--type", "gui"])

    IS_START = True

    return jsonify(response="Analysis started",status=200)



@app.route("/stop", methods=["POST"])
def stop():
    global IS_START

    print("\n- - - Stopping Analysis - - -\n")
    vbox(["controlvm", VM_NAME, "poweroff"])
    
    IS_START = False

    return jsonify(response="Analysis stopped", status=200)

@app.route("/runScript", methods=["POST"])
def runScript():
    print("\n- - - Running Script - - -\n")
    if not VM_USERNAME or not VM_PASSWORD:
        return jsonify(
            error="VM_USERNAME and VM_PASSWORD must be set in .env",
            status=500
        ), 500
    args = [
        "guestcontrol", VM_NAME, "run",
        "--username", VM_USERNAME,
        "--password", VM_PASSWORD,
        "--exe", "cmd.exe", "--", "cmd", "/c", GUEST_SCRIPT_PATH
    ]
    returncode, stdout, stderr = vbox(args, capture_output=True)
    if returncode != 0:
        print(f"VBoxManage guestcontrol failed (returncode={returncode})\nstderr: {stderr}\nstdout: {stdout}")
        hint = "Check: Guest Additions installed, GUEST_SCRIPT_PATH correct in guest, credentials valid."
        return jsonify(
            error="Script execution failed",
            returncode=returncode,
            stderr=stderr,
            stdout=stdout,
            hint=hint,
            status=500
        ), 500
    return jsonify(response="Script run", stdout=stdout, status=200)

if __name__ == "__main__":
    app.run(port=8003, debug=True)
