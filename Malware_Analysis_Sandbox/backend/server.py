from dotenv import load_dotenv
from flask import Flask, jsonify
from flask_cors import CORS
import subprocess
import threading
import time
import os

# =====================
# CONFIG
# =====================
load_dotenv()

VBOX = os.getenv("VBOX_PATH", "VBoxManage.exe")
VM = os.getenv("VM_NAME")
USER = os.getenv("VM_USERNAME")
PASS = os.getenv("VM_PASSWORD")
MONITOR_DIR = os.getenv("MONITOR_DIR", "/home/analyst/monitor")

if not all([VM, USER, PASS]):
    raise RuntimeError("Missing VM configuration in .env")

app = Flask(__name__)
CORS(app)

LOGS = []
STOP_EVENT = threading.Event()
STOP_EVENT.set()  # Start in "stopped" state so status is correct before /start
LISTENER_THREAD = None


# =====================
# VBOX HELPERS
# =====================
def vbox(*args):
    try:
        r = subprocess.run(
            [VBOX, *args],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            encoding="utf-8",
            errors="ignore",
            timeout=20,
            creationflags=subprocess.CREATE_NO_WINDOW if os.name == "nt" else 0
        )
        return r.returncode == 0, r.stdout.strip(), r.stderr.strip()
    except Exception as e:
        return False, str(e), str(e)


def is_vm_running():
    ok, out, _ = vbox("showvminfo", VM, "--machinereadable")
    if not ok:
        return False
    return 'VMState="running"' in out


def start_vm():
    if is_vm_running():
        return True, "VM already running"
    ok, out, err = vbox("startvm", VM, "--type", "headless")
    return ok, out or err


def guest_bash(cmd):
    ok, out, _ = vbox(
        "guestcontrol", VM, "run",
        "--username", USER,
        "--password", PASS,
        "/bin/bash",
        "--", "-c", cmd
    )
    return out if ok else ""


# =====================
# LISTENER LOOP
# =====================
def listen():
    # Monitor user home and /tmp only (paths user can access). Avoid /home/ubuntu when user is "user"
    home_dir = f"/home/{USER}"
    watch_dirs = f"{home_dir} /tmp"
    guest_bash(f"mkdir -p {home_dir}/monitor 2>/dev/null")

    while not STOP_EVENT.is_set():
        # inotifywait blocks until a file event (or -t 30 timeout to allow stop check)
        fs = guest_bash(
            f"inotifywait -r -e create,modify,delete --format '%e %w%f' "
            f"-t 30 {watch_dirs} 2>/dev/null"
        ).strip()

        if STOP_EVENT.is_set():
            break
        if not fs:
            continue  # Timeout with no event, loop again

        ts = time.strftime("%Y-%m-%d %H:%M:%S")
        net = guest_bash("ss -tunap 2>/dev/null | tail -n +2").strip()
        procs = guest_bash(
            f"ps -u {USER} --no-headers -o pid,stat,etime,args 2>/dev/null | head -20"
        ).strip()

        LOGS.append({
            "time": ts,
            "filesystem": fs,
            "network": net or "(none)",
            "processes": procs or "(none)"
        })


# =====================
# API
# =====================
@app.route("/start", methods=["POST"])
def start():
    ok, msg = start_vm()
    if not ok:
        return jsonify(error="Failed to start VM", details=msg), 500

    LOGS.clear()
    STOP_EVENT.clear()

    global LISTENER_THREAD
    LISTENER_THREAD = threading.Thread(target=listen, daemon=True)
    LISTENER_THREAD.start()

    return jsonify(message="Ubuntu sandbox monitoring started")


@app.route("/stop", methods=["POST"])
def stop():
    STOP_EVENT.set()
    return jsonify(message="Monitoring stopped")


@app.route("/logs", methods=["GET"])
def logs():
    return jsonify(LOGS)


@app.route("/status", methods=["GET"])
def status():
    return jsonify(
        vm_running=is_vm_running(),
        monitoring=not STOP_EVENT.is_set(),
        entries=len(LOGS)
    )


@app.route("/debug", methods=["GET"])
def debug():
    """Test VM connectivity - open http://localhost:8003/debug in browser"""
    vm_ok = is_vm_running()
    result = {"vm_running": vm_ok, "user": USER, "vm_name": VM}

    if not vm_ok:
        result["error"] = "VM is not running"
        return jsonify(result)

    # Test guestcontrol with a simple command
    ok, out, err = vbox(
        "guestcontrol", VM, "run",
        "--username", USER,
        "--password", PASS,
        "/bin/bash", "--", "-c", "echo OK"
    )
    result["guestcontrol_ok"] = ok
    result["guestcontrol_stdout"] = out
    result["guestcontrol_stderr"] = err

    if ok:
        # Test whoami, ps, inotifywait
        result["whoami"] = guest_bash("whoami")
        result["ps_sample"] = guest_bash(f"ps -u {USER} --no-headers 2>/dev/null | head -3")
        result["inotifywait_installed"] = "inotifywait" in (guest_bash("which inotifywait 2>/dev/null") or "")
        result["ss_installed"] = "ss" in (guest_bash("which ss 2>/dev/null") or "")

    return jsonify(result)


# =====================
if __name__ == "__main__":
    app.run(port=8003, debug=True)
